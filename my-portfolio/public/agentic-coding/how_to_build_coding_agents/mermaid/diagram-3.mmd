---
config:
  look: neo
  theme: base
  themeVariables:
    fontFamily: 'Inter, ui-sans-serif, system-ui'
    fontSize: '16px'
    primaryTextColor: '#0F172A'
    lineColor: '#334155'
    edgeLabelBackground: '#FFFFFF'
    clusterTextSize: '15px'
    clusterTextWeight: '600'
    borderRadius: '4'
    shadowColor: '#000000'
    shadowOpacity: '0.12'
    shadowBlur: '4'
  flowchart:
    curve: basis
    nodeSpacing: 50
    rankSpacing: 70
---
flowchart TB
  Q[User task] --> P[Plan / Todos]

  subgraph C[Context Builder]
    RM[Repo Map<br/>symbols + files + deps]
    HY[Hybrid Retrieval<br/>grep + embeddings]
    SEL[Selection Policy<br/>top-k chunks + file caps]
    CMP[Compression<br/>summarize tool outputs]
    ISO[Isolation via Subagents<br/>explore -> distilled report]
  end

  P --> HY
  RM --> HY
  HY --> SEL --> CMP --> CTX[Final Prompt Context]
  ISO --> CTX

  CTX --> LLM[Model Call]
  LLM --> ACT[Next Action]

  classDef ctx fill:#E0F2FE,stroke:#38BDF8,stroke-width:2px,color:#0F172A;
  classDef box fill:#FEF9C3,stroke:#FACC15,stroke-width:2px,color:#0F172A;

  class C,RM,HY,SEL,CMP,ISO ctx;
  class Q,P,CTX,LLM,ACT box;

  style C fill:#F8FAFC,stroke:#94A3B8,stroke-width:2px,rx:6,ry:6,font-size:15px,font-weight:600
