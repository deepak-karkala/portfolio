---
config:
  look: neo
  theme: base
  themeVariables:
    fontFamily: 'Inter, ui-sans-serif, system-ui'
    fontSize: '16px'
    primaryTextColor: '#0F172A'
    lineColor: '#334155'
    edgeLabelBackground: '#FFFFFF'
    clusterTextSize: '15px'
    clusterTextWeight: '600'
    borderRadius: '4'
    shadowColor: '#000000'
    shadowOpacity: '0.12'
    shadowBlur: '4'
---
sequenceDiagram
  autonumber
  participant User
  participant UI as CLI/IDE UI
  participant Agent as Agent Loop
  participant Tools as Tools (read/grep/edit/run)
  participant V as Verifier (lint/tests)
  participant FS as Repo/FS
  participant Shell as Sandbox/Shell

  User->>UI: "Fix failing tests in auth module"
  UI->>Agent: task + repo context pointers

  loop until done or escalate
    Agent->>Tools: grep("auth", "failing test name")
    Tools->>FS: read/search
    FS-->>Tools: matches + snippets
    Tools-->>Agent: observations

    Agent->>Tools: read_range(file, lines)
    Tools->>FS: read
    FS-->>Tools: code chunk
    Tools-->>Agent: chunk

    Agent->>Tools: edit_patch(diff)
    Tools->>FS: apply patch
    FS-->>Tools: ok/fail
    Tools-->>Agent: patch result

    Agent->>Tools: run("pytest -k auth")
    Tools->>Shell: execute
    Shell-->>Tools: stdout/stderr + exit code
    Tools-->>Agent: run result

    Agent->>V: interpret failures + propose next fix
    V-->>Agent: verifier feedback
  end

  Agent-->>UI: final diff + summary + commands run
  UI-->>User: present changes + approve/merge
